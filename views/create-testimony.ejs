<!doctype html>
<html lang="en">
  <head>
    <title>Parish Church Testimony Form</title>
    <meta charset="utf-8" />
    <meta name="description" content="Submit your testimony" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.png" />

    <!-- CSS Files -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/css/animate.css" />
    <link rel="stylesheet" href="/css/all.min.css" />
    <link rel="stylesheet" href="/css/owl.carousel.min.css" />
    <link rel="stylesheet" href="/css/nice-select.css" />
    <link rel="stylesheet" href="/css/magnific-popup.css" />
    <link rel="stylesheet" href="/css/meanmenu.css" media="all" />
    <link rel="stylesheet" href="/css/default.css" />
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" class="color-changing" href="/css/color6.css" />
    <link rel="stylesheet" href="/css/responsive.css" />
    <!-- End CSS Files -->

    <script
      src="https://cdn.tiny.cloud/1/m714jundcur08b881q7qay47h9tzu21x2xayvvxzk6b6v34z/tinymce/7/tinymce.min.js"
      referrerpolicy="origin"
    ></script>
  </head>

  <body>
    <!-- Preloader start -->
    <div class="loader-out flex-center">
      <div class="loader"></div>
    </div>
    <!-- Preloader end -->

    <!-- Header start -->
    <%- include('header') %>
    <!-- Header end -->

    <!-- Testimony Quote start -->
    <section class="contact-2 pt-75">
      <div class="container">
        <div class="row mb-40">
          <div class="col-lg-12 mb-55 mb-sm-30">
            <h2 class="f-600 fs-28 text-left text-lg-center">
              I will speak of thy testimonies also before kings, and will not be
              ashamed. â€“ Psalm 119:46
              <span class="fade-texts my-style transform-center"
                >TESTIMONY</span
              >
            </h2>
          </div>
        </div>
      </div>
    </section>
    <!-- Testimony Quote end -->

    <!-- Contact Form start -->
    <section class="contact-form pt-0 pb-80">
      <div class="container">
        <div class="yellow-border-7 shadow-2">
          <!-- Form Header -->
          <div class="row">
            <div class="col-lg-12">
              <h2 class="f-700 mb-25 fs-41 text-left text-lg-center">
                Testimony Details
              </h2>
            </div>
          </div>
          <!-- Form Body -->
          <div class="row">
            <div class="col-lg-12">
              <form
                id="testimonyForm"
                class="relative z-5 mt-10 align-items-center"
              >
                <div class="row">
                  <!-- First Name Field -->
                  <div class="col-lg-6">
                    <div class="form-group relative mb-30 mb-sm-20">
                      <input
                        type="text"
                        class="form-control input-lg input-white shadow-5"
                        name="firstName"
                        id="firstName"
                        placeholder="First Name"
                        value="<%= session.firstName %>"
                      />
                      <i class="far fa-user transform-v-center"></i>
                      <span id="firstNameError" class="text-danger"></span>
                    </div>
                  </div>

                  <!-- Last Name Field -->
                  <div class="col-lg-6">
                    <div class="form-group relative mb-30 mb-sm-20">
                      <input
                        type="text"
                        class="form-control input-lg input-white shadow-5"
                        name="lastName"
                        id="lastName"
                        placeholder="Last Name"
                        value="<%= session.lastName %>"
                      />
                      <i class="far fa-user transform-v-center"></i>
                      <span id="lastNameError" class="text-danger"></span>
                    </div>
                  </div>

                  <!-- Email Field -->
                  <div class="col-lg-6">
                    <div class="form-group relative mb-30 mb-sm-20">
                      <input
                        type="email"
                        class="form-control input-lg input-white shadow-5"
                        id="email"
                        placeholder="Email Address"
                        value="<%= session.email %>"
                      />
                      <i class="fas fa-envelope transform-v-center"></i>
                      <span id="emailError" class="text-danger"></span>
                    </div>
                  </div>

                  <!-- Address Field -->
                  <div class="col-lg-6">
                    <div class="form-group relative mb-30 mb-sm-20">
                      <input
                        type="text"
                        class="form-control input-lg input-white shadow-5"
                        id="address"
                        placeholder="Address"
                      />
                      <i class="fas fa-location transform-v-center"></i>
                      <span id="addressError" class="text-danger"></span>
                    </div>
                  </div>

                  <!-- Country Dropdown (Fetched from Public API) -->
                  <div class="col-lg-6">
                    <div class="form-group relative mb-30 mb-sm-20">
                      <select
                        class="form-control input-lg input-white shadow-5"
                        id="country"
                        name="country"
                      >
                        <option value="">Select Country</option>
                      </select>
                      <i class="fas fa-globe transform-v-center"></i>
                      <span id="countryError" class="text-danger"></span>
                    </div>
                  </div>

                  <div class="col-lg-6">
                    <div class="form-group relative mb-30 mb-sm-20">
                      <select
                        class="form-control input-lg input-white shadow-5"
                        id="category"
                        name="category"
                      >
                        <option value="">Select Category</option>
                      </select>
                      <i class="fas fa-list transform-v-center"></i>
                      <span id="categoryError" class="text-danger"></span>
                    </div>
                  </div>

                  <!-- Phone Number Field -->
                  <div class="col-lg-6">
                    <div class="form-group relative mb-30 mb-sm-20">
                      <input
                        type="number"
                        class="form-control input-lg input-white shadow-5"
                        id="phoneNumber"
                        placeholder="Phone Number"
                      />
                      <i class="fas fa-mobile-alt transform-v-center"></i>
                      <span id="phoneNumberError" class="text-danger"></span>
                    </div>
                  </div>

                  <!-- File Upload Field -->
                  <div class="col-lg-6">
                    <div class="form-group relative mb-30 mb-sm-20">
                      <input
                        type="file"
                        class="form-control input-lg input-white shadow-5"
                        id="formFile"
                        accept="image/jpeg, image/png"
                      />
                      <span id="fileError" class="text-danger"></span>
                    </div>
                  </div>

                  <!-- Anonymous Checkbox -->
                  <div class="col-lg-6">
                    <div class="form-group relative mb-30 mb-sm-20">
                      <div class="input-group">
                        <div class="input-group-text w-30 h-30">
                          <input
                            class="form-control"
                            type="checkbox"
                            id="anonymous"
                            name="anonymous"
                            aria-label="anonymous"
                          />
                        </div>
                        <input
                          class="form-control"
                          type="text"
                          value="Do you want to be anonymous"
                          aria-label="anonymous"
                          disabled
                          readonly
                        />
                      </div>
                      <span id="anonymousError" class="text-danger"></span>
                    </div>
                  </div>

                  <!-- Image Preview Section -->
                  <div class="col-lg-12">
                    <div class="form-group relative mb-30 mb-sm-20">
                      <img
                        id="imagePreview"
                        src="#"
                        alt="Image Preview"
                        style="
                          display: none;
                          max-width: 200px;
                          max-height: 200px;
                          object-fit: contain;
                          border: 1px solid #ccc;
                          padding: 5px;
                        "
                      />
                    </div>
                  </div>

                  <!-- Message Editor Field -->
                  <div class="col-md-12">
                    <div class="form-group relative mb-30 mb-sm-20">
                      <textarea
                        class="form-control input-white shadow-5"
                        name="message"
                        id="message"
                        cols="30"
                        rows="7"
                        placeholder="Your message"
                      ></textarea>
                      <span id="messageError" class="text-danger"></span>
                    </div>
                  </div>

                  <!-- Submit Button -->
                  <div class="col-lg-12 text-center mt-10 mb-5">
                    <button type="submit" class="btn btn-black shadow-1">
                      SUBMIT
                    </button>
                  </div>
                </div>
              </form>
              <!-- Upload Status Indicator -->
              <div id="uploadStatus" style="display: none">Uploading...</div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- Contact Form end -->

    <!-- Footer start -->
    <%- include('footer') %>
    <!-- Footer end -->

    <!-- JS Files -->
    <script src="/js/modernizr-3.5.0.min.js"></script>
    <script src="/js/jquery-1.12.4.min.js"></script>
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/js/owl.carousel.min.js"></script>
    <script src="/js/jquery.magnific-popup.min.js"></script>
    <script src="/js/jquery.nice-select.min.js"></script>
    <script src="/js/jquery.waypoints.min.js"></script>
    <script src="/js/jquery.counterup.min.js"></script>
    <script src="/js/jquery.countdown.min.js"></script>
    <script src="/js/lightslider.min.js"></script>
    <script src="/js/wow.min.js"></script>
    <script src="/js/isotope.pkgd.min.js"></script>
    <script src="/js/jquery.meanmenu.min.js"></script>
    <script src="/js/tilt.jquery.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/audio-file.js"></script>
    <!-- JS Files end -->

    <!-- Custom JavaScript -->
    <script>
      // Cloudinary Configuration
      const CLOUDINARY_URL =
        'https://api.cloudinary.com/v1_1/drtsuuj3r/image/upload';
      const UPLOAD_PRESET = 'ml_default';

      /**
       * Image Preview Handler
       * Displays a preview of the selected image file.
       */
      if (document.getElementById('formFile')) {
        document
          .getElementById('formFile')
          .addEventListener('change', function (event) {
            const fileInput = event.target;
            const file = fileInput.files[0];
            const imagePreview = document.getElementById('imagePreview');

            // Validate if the file is an image
            if (file && file.type.startsWith('image/')) {
              const reader = new FileReader();

              // Load the image and display it in the preview element
              reader.onload = function (e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block'; // Show the image preview
              };

              reader.readAsDataURL(file);
            } else {
              // Clear the preview if it's not an image
              imagePreview.src = '#';
              imagePreview.style.display = 'none';
            }
          });
      }

      /**
       * Form Submission Handler
       * Validates form inputs, uploads the image to Cloudinary, and submits the form data.
       */
      document
        .getElementById('testimonyForm')
        .addEventListener('submit', async function (event) {
          event.preventDefault();
          let isValid = true;

          // Clear previous error messages
          document
            .querySelectorAll('.text-danger')
            .forEach((span) => (span.innerText = ''));

          // Validate First Name
          const firstName = document.getElementById('firstName').value.trim();
          if (firstName === '') {
            document.getElementById('firstNameError').innerText =
              'First name is required.';
            isValid = false;
          }

          // Validate Last Name
          const lastName = document.getElementById('lastName').value.trim();
          if (lastName === '') {
            document.getElementById('lastNameError').innerText =
              'Last name is required.';
            isValid = false;
          }

          // Validate Email
          const email = document.getElementById('email').value.trim();
          if (email === '') {
            document.getElementById('emailError').innerText =
              'Email is required.';
            isValid = false;
          } else if (!validateEmail(email)) {
            document.getElementById('emailError').innerText =
              'Please enter a valid email.';
            isValid = false;
          }

          // Validate Address
          const address = document.getElementById('address').value.trim();
          if (address === '') {
            document.getElementById('addressError').innerText =
              'Address is required.';
            isValid = false;
          }

          // Validate Country
          const country = document.getElementById('country').value.trim();
          if (country === '') {
            document.getElementById('countryError').innerText =
              'Country is required.';
            isValid = false;
          }

          // Validate Category
          const category = document.getElementById('category').value.trim();
          if (category === '') {
            document.getElementById('categoryError').innerText =
              'Testimony category is required.';
            isValid = false;
          }

          // Validate Phone Number
          const phoneNumber = document
            .getElementById('phoneNumber')
            .value.trim();
           if (isNaN(phoneNumber)) {
            document.getElementById('phoneNumberError').innerText =
              'Phone Number must be a number.';
            isValid = false;
          }

          // Validate Message
          tinymce.triggerSave();
          const message = document.getElementById('message').value.trim();
          if (message === '') {
            document.getElementById('messageError').innerText =
              'Message is required.';
            isValid = false;
          }

          // Validate File Input
          const file = document.getElementById('formFile').files[0];
          console.log('file', file);

          if (file) {
            console.log('Entered here');
            // Validate file type (only images allowed: JPEG, PNG)
            const allowedTypes = ['image/jpeg', 'image/png'];
            if (!allowedTypes.includes(file.type)) {
              document.getElementById('fileError').innerText =
                'Only JPEG and PNG files are allowed.';
              isValid = false;
            }

            // Validate file size (example: max 3MB)
            const maxSizeInBytes = 3 * 1024 * 1024; // 3MB
            if (file.size > maxSizeInBytes) {
              document.getElementById('fileError').innerText =
                'File size must be less than 3MB.';
              isValid = false;
            }
          }

          if (!isValid) return;

          // Show upload status
          document.getElementById('uploadStatus').style.display = 'block';

          let imageUrl = '';
          if (file) {
            // Upload Image to Cloudinary
            const formData = new FormData();
            formData.append('file', file); // The file from the input
            formData.append('upload_preset', UPLOAD_PRESET); // Your Cloudinary preset

            try {
              const response = await fetch(CLOUDINARY_URL, {
                method: 'POST',
                body: formData,
              });

              const data = await response.json();

              document.getElementById('uploadStatus').style.display = 'none';

              imageUrl = data.secure_url;
            } catch (error) {
              console.error('Cloudinary upload failed:', error);
              alert('Failed to upload image');
              return;
            }
          }

          const formDataJson = {
            firstname: document.getElementById('firstName').value,
            lastname: document.getElementById('lastName').value,
            email: document.getElementById('email').value,
            address: document.getElementById('address').value,
            country: document.getElementById('country').value,
            categoryUuid: document.getElementById('category').value,
            phoneNumber: document.getElementById('phoneNumber').value,
            anonymous: document.getElementById('anonymous').checked,
            testimony: message,
          };

          if (file) {
            formDataJson.image = imageUrl;
          }

          try {
            const postResponse = await fetch('/testimony', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(formDataJson),
            });
            console.log(postResponse);

            if (postResponse.ok) {
              alert('Thanks for sharing your testimony, Our team will review it and send an email to you once your testimony is made public.');
              window.location.href = '/';
            } else {
              alert('Error submitting form.');
            }
          } catch (error) {
            console.error('Form submission failed:', error);
            alert('Failed to submit form.');
          }
        });

      function validateEmail(email) {
        const re = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
        return re.test(String(email).toLowerCase());
      }

      async function fetchCountries() {
        try {
          const response = await fetch(
            'https://countriesnow.space/api/v0.1/countries',
          );
          const countries = await response.json();

          const countrySelect = document.getElementById('country');

          countries.data.sort((a, b) => a.country.localeCompare(b.country));

          countries.data.forEach((country) => {
            const option = document.createElement('option');
            option.value = country.country;
            option.text = country.country;
            countrySelect.add(option);
          });
        } catch (error) {
          console.error('Failed to fetch countries:', error);
        }
      }

      async function fetchCategories() {
        try {
          const response = await fetch('categories');
          // console.log(response.body);
          let allCategories = await response.json();
          let categories = allCategories.categories;
          console.log(categories.categories);

          const categorySelect = document.getElementById('category');

          if (categories.length > 0) {
            categories.forEach((category) => {
              const option = document.createElement('option');
              option.value = category.uuid;
              option.text = category.name;
              categorySelect.appendChild(option);
            });
          } else {
            const option = document.createElement('option');
            option.value = '';
            option.text = 'No categories available';
            categorySelect.appendChild(option);
          }
        } catch (error) {
          console.error('Error fetching categories:', error);
        }
      }

      document.addEventListener('DOMContentLoaded', function () {
        fetchCountries();
        fetchCategories();

        tinymce.init({
          selector: '#message',
          plugins:
            'advlist autolink lists link image charmap print preview hr anchor pagebreak',
          toolbar_mode: 'floating',
        });
      });
    </script>
  </body>
</html>
